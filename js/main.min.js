!function(){"use strict";var e=void 0,t=void 0,n=void 0,o=function(){window.oncontextmenu=function(){return!1},document.oncontextmenu=function(){return!1},e=document.getElementById("roomNumber"),t=document.getElementById("map"),n=document.getElementById("message"),u(),c()},r=function(t){return e.innerHTML=t},i=function(e){return"hidden"==t.className?t.className="show":t.className="hidden"},a=function(e,t){n.className="show",n.innerHTML=e,t&&setTimeout(function(){n.innerHTML="",n.className="hidden"},5e3)},s={up:!1,left:!1,right:!1,s:!1,m:!1},d=function(e,t){switch(e.keyCode){case 38:s.up=t;break;case 37:s.left=t;break;case 39:s.right=t;break;case 83:m();break;case 77:t&&i()}},u=function(){document.addEventListener("keydown",function(e){return d(e,!0)}),document.addEventListener("keyup",function(e){return d(e,!1)})},c=function(){var e=document.getElementById("button-left");e.addEventListener("touchstart",function(){s.left=!0},!1),e.addEventListener("touchend",function(){s.left=!1},!1);var t=document.getElementById("button-right");t.addEventListener("touchstart",function(){s.right=!0},!1),t.addEventListener("touchend",function(){s.right=!1},!1);var n=document.getElementById("button-forvard");n.addEventListener("touchstart",function(){s.up=!0},!1),n.addEventListener("touchend",function(){s.up=!1},!1),document.getElementById("button-map").addEventListener("touchend",function(){i()},!1)},m=function(){},l=function(e){return m=e},p=function(e){document.getElementById("preloader").className="hidden";var t=document.getElementById("button-start");t.className="show",t.addEventListener("touchstart",function(e){if("touchstart"===e.type){document.getElementById("buttons").style.display="flex";var t=document.getElementById("app");t.requestFullScreen?t.requestFullScreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullScreen&&t.webkitRequestFullScreen()}}),t.addEventListener("mousedown",function(){document.getElementById("app").className="show",document.getElementById("start-screen-wrapper").style.display="none",e()})},w={textures:{stone:{map:null,src:"assets/stone.jpg"},wood:{map:null,src:"assets/wood.jpg"},books:{map:null,src:"assets/books.jpg"},window:{map:null,src:"assets/window.jpg"}},geoms:{lab:{geom:null,src:"assets/walls.obj"}}},h=[],E=0,f=function(e){var t=v(w.textures,g),n=y(w.geoms,g);h=t.concat(n),h.push(e),h[0]()},g=function(){E++,h[E]()},v=function(e,t){var n=new THREE.TextureLoader,o=[];for(var r in e)!function(r){o.push(function(){n.load(e[r].src,function(n){e[r].map=n,t()})})}(r);return o},y=function(e,t){var n=new THREE.OBJLoader,o=[];for(var r in e)!function(r){o.push(function(){n.load(e[r].src,function(n){e[r].geom=n,t()})})}(r);return o},T={},R=function(){T.stone=new THREE.MeshPhongMaterial({map:w.textures.stone.map}),T.stone.map.wrapS=T.stone.map.wrapT=THREE.RepeatWrapping,T.books=new THREE.MeshPhongMaterial({map:w.textures.books.map,color:2629909}),T.wood=new THREE.MeshPhongMaterial({map:w.textures.wood.map,color:16777215}),T.books.map.wrapS=T.books.map.wrapT=THREE.RepeatWrapping,T.easy=new THREE.MeshPhongMaterial({color:16777215}),T.window=new THREE.MeshPhongMaterial({map:w.textures.window.map}),T.mirror=new THREE.MeshPhongMaterial({color:65280})},H=function(e,t){if(!w.textures[e]){var n=document.createElement("canvas"),o=n.getContext("2d");o.font="100pt Arial",o.strokeStyle="white",o.textAlign="bottom",o.fillStyle="white",o.fillText(e,100,.8*n.height);var r=new THREE.Texture(n);r.needsUpdate=!0,w.textures[e]={},w.textures[e].map=r,T[e]=new THREE.MeshBasicMaterial({color:16777215,opacity:1,alphaMap:w.textures[e].map,transparent:!0}),T[e].needsUpdate=!0}},b=void 0,M=void 0,x=void 0,k=void 0,B=function(){k=new THREE.WebGLRenderer({canvas:document.getElementById("webgl-canvas"),antialias:!0}),k.setClearColor(0),k.setPixelRatio(window.devicePixelRatio),k.setSize(window.innerWidth,window.innerHeight),b=new THREE.PerspectiveCamera(120,window.innerWidth/window.innerHeight,.1,50),b.position.y=1.7,b.position.x=66,b.position.z=5,M=new THREE.Mesh(new THREE.BoxGeometry(.001,.001,.001),new THREE.MeshBasicMaterial({color:16711680})),M.position.z=-1,x=new THREE.Scene,x.add(b),b.add(M),x.fog=new THREE.FogExp2(1840660,.05,100);var e=new THREE.AmbientLight(16777215,1.2);e.position.set(5,5,5),x.add(e);var t=new THREE.PointLight(6380825,3.5);t.position.set(0,3,0),b.add(t);var n=new THREE.PlaneGeometry(1e3,1e3,5,5),o=T.stone.map.clone(),r=new THREE.MeshPhongMaterial({map:o}),i=new THREE.Mesh(n,r);i.material.map.repeat.set(100,100),o.needsUpdate=!0,i.position.y=6,i.rotation.x=.5*Math.PI,x.add(i)},P=function(){window.onresize=function(){k.setSize(window.innerWidth,window.innerHeight),b.aspect=window.innerWidth/window.innerHeight,b.updateProjectionMatrix()}},L=void 0,S=void 0,I=function(){L=new THREE.PerspectiveCamera(120,2.2/3.1,.1,50),L.position.set(-3.7,1.7,47.7),S=new THREE.WebGLRenderTarget(100,200,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter}),T.mirror=new THREE.MeshBasicMaterial({map:S.texture}),F.material=T.mirror,F.material.needsUpdate=!0},D=function(){L.rotation.y=b.rotation.y-3.14,k.render(x,L,S)},F=null,N=function(e){e.secretDoor=new THREE.Group,x.add(e.secretDoor),w.geoms.lab.geom.traverse(function(t){if(t instanceof THREE.Mesh!=1)return _(t.name,"room")&&V(t,"room"),_(t.name,"secret")&&V(t,"secret"),_(t.name,"exit")&&V(t,"exit"),_(t.name,"password")&&V(t,"password"),_(t.name,"book_area")&&V(t,"secretBook"),_(t.name,"sdoor_area")&&V(t,"mirrorDoor"),void(_(t.name,"trap_area")&&V(t,"trap"));if("books"==t.name){var n=new THREE.Mesh(t.geometry,T.books);x.add(n)}else if("window"==t.name){var o=new THREE.Mesh(t.geometry,T.window);x.add(o)}else if("wood"==t.name){var r=new THREE.Mesh(t.geometry,T.wood);x.add(r)}else if("candle"==t.name){var i=new THREE.Mesh(t.geometry,T.easy);x.add(i)}else if("book"==t.name){var a=new THREE.Mesh(t.geometry,T.wood);x.add(a),e.secretBook=a}else if("password_List"==t.name){var s=new THREE.Mesh(t.geometry,T.easy);x.add(s),e.passwordPaper=s}else if("mirror_wood"==t.name){var d=new THREE.Mesh(t.geometry,T.wood);e.secretDoor.add(d)}else if("mirror"==t.name){var u=new THREE.Mesh(t.geometry,T.mirror);e.secretDoor.add(u),F=u}else if(_(t.name,"letter")){var c=t.name.substring(t.name.length-1,t.name.length);H(c);var m=new THREE.Mesh(t.geometry,T[c]);x.add(m)}else{var l=new THREE.Mesh(t.geometry,T.stone);x.add(l)}})},_=function(e,t){return!!~e.indexOf(t)},z=function(e){return x.remove(e)},A=[],W=[],C=[],j=[],q=[],G=[],U=[],V=function(e,t){for(var n=e.geometry.attributes.position.array,o=[],r=0;r<n.length-3;r+=3)o.push(new SAT.Vector(n[r],n[r+2]));var i={name:e.name,poligon:new SAT.Polygon(new SAT.Vector,o)};"room"==t&&A.push(i),"secret"==t&&W.push(i),"exit"==t&&C.push(i),"password"==t&&j.push(i),"secretBook"==t&&q.push(i),"mirrorDoor"==t&&G.push(i),"trap"==t&&U.push(i)},O=function(){return[].push.apply(A,W)},J=function(e){var t=!1,n=new THREE.Vector3;M.getWorldPosition(n);var o=new SAT.Vector(n.x,n.z),r=void 0;return"rooms"==e&&(r=A),"secrets"==e&&(r=W),"exits"==e&&(r=C),"passwords"==e&&(r=j),"secretBooks"==e&&(r=q),"mirrorDoor"==e&&(r=G),"traps"==e&&(r=U),r.forEach(function(e){SAT.pointInPolygon(o,e.poligon)&&(t=e.name)}),t},Y=!0,Z="",K=function e(){Y&&(s.up&&Q(),s.left&&(b.rotation.y+=.02),s.right&&(b.rotation.y-=.02)),$(b),k.render(x,b),"room_S"!=Z&&"room_Y"!=Z||D(),requestAnimationFrame(e)},Q=function(){if((Z=J("rooms"))&&(X(J),b.translateZ(-.15),"room_Door"!=Z))return"secret"==Z?void r("Secret room"):void r(Z[Z.length-1])},X=function(){},$=function(){},ee=function(e,t){X=e,$=t},te=function(){return Y=!1};window.onload=function(){o(),f(function(){R(),B(),N(oe),I(),P(),ee(ie,se),l(de),p(function(){K(),a(ue.start,!0)})})};var ne="findPassword",oe={passwordPaper:null,secretDoor:null,secretBook:null},re=void 0,ie=function(){if(J("traps")){if("nearTrap"==ne)return;re=ne,ne="nearTrap",setTimeout(function(){J("traps")?(te(),ne="die"):ne=re},3e3)}"findPassword"==ne&&J("passwords")&&(ne="findDoor",z(oe.passwordPaper),a(ue.findPass,!0)),"findDoor"==ne&&J("mirrorDoor")&&(ne="findBook",ae=!0),"findBook"==ne&&J("secrets")&&J("secretBooks")&&(z(oe.secretBook),a(ue.findBook,!0),ne="findExit"),"findExit"==ne&&J("exits")&&(te(),ne="win",a(ue.findExit,!1))},ae=!1,se=function(e){"findBook"==ne&&ae&&(oe.secretDoor.position.y<3?oe.secretDoor.position.y+=.05:O()),"die"==ne&&(e.position.y>-1.6?(e.position.y-=.01,e.rotation.z-=.001):(a(ue.lose,!1),ne="lose"))},de=function(){return ae=!0},ue={start:'<img src="assets/enter_message.png" style="width: 50vh; height: auto;"/>',findPass:'<img src="assets/pass.png" style="width: 50vh; height: auto;"/>',findBook:'<img src="assets/book.png" style="width: 50vh; height: auto;"/>',findExit:'<img src="assets/exit_message.png" style="width: 50vh; height: auto;"/><br/><div id="endCopyright"><a href="http://otrisovano.ru" target="blank">&copy; www.otrisovano.ru</a><br/><a href="https://github.com/fire888/rosa" target="blank">github</a></div>',lose:'<img src="assets/rip.png" style="width: 50vh; height: auto;"/><div id="endCopyright"><a href="http://js.otrisovano.ru/rosa">Restart</a></div>'}}();
